use quirky_binder::{
    filter::{
        debug::debug,
        function::{
            emit::function_emit,
            terminate::function_terminate,
        },
        group::group,
        sort::sort,
    },
};

{
  (
      function_emit(
        fields: [("num", "u8"), ("lsb2", "u8")],
        body: r#"
            use fallible_iterator::IteratorExt;
            use rand::Rng;
            use rand_chacha::rand_core::SeedableRng;

            let mut rng = rand_chacha::ChaCha8Rng::from_entropy();
            println!("Seed: {:02x?}", rng.get_seed());

            (0..1024)
                .map(move |_| {
                    let num: u8 = rng.gen();
                    let record = (num, num & 0x03).into();
                    Ok(record)
                })
                .transpose_into_fallible()
"#,
      )
    - sort(fields: ["lsb2"])
    - group(by_fields: ["lsb2"], group_field: "group")
    - debug()
    - function_terminate(
        body: r#"
            use std::collections::BTreeSet;

            let mut read = 0;
            let mut seen = BTreeSet::<u8>::new();
            while let Some(group_record) = input.next()? {
                let lsb2 = *group_record.lsb2();
                assert!(!seen.contains(&lsb2), "Already seen lsb2 {lsb2}");
                seen.insert(lsb2);
                for record in group_record.group().iter() {
                    assert_eq!(lsb2, record.num() & 0x03, "lsb2");
                    read += 1;
                }
            }
            assert_eq!(1024, read);
            Ok(())
"#,
      )
  )
}
