use quirky_binder::{
    filter::{
        fork::join::join,
        function::{
            emit::function_emit,
            terminate::function_terminate,
        },
    },
};

{
  (
      function_emit(
        fields: [("num", "i8")],
        body: r#"
            use std::collections::BTreeSet;

            use fallible_iterator::IteratorExt;
            use rand::Rng;
            use rand_chacha::rand_core::SeedableRng;

            let mut rng = rand_chacha::ChaCha8Rng::from_entropy();
            println!("Seed: {:02x?}", rng.get_seed());

            let nums = (0..1024)
                .map(|_| rng.gen())
                .collect::<BTreeSet<i8>>();
            nums
                .into_iter()
                .map(|num| {
                    let record = num.into();
                    Ok(record)
                })
                .transpose_into_fallible()
"#,
        order_fields: Some(["num"]),
        distinct_fields: Some(["num"]),
      )
    -> stream_1
  )

  (
      function_emit(
        fields: [("other_num", "i8"), ("lsb4", "Option<u8>")],
        body: r#"
            use std::collections::BTreeSet;

            use fallible_iterator::IteratorExt;
            use rand::Rng;
            use rand_chacha::rand_core::SeedableRng;

            let mut rng = rand_chacha::ChaCha8Rng::from_entropy();
            println!("Seed: {:02x?}", rng.get_seed());

            let nums = (0..1024)
                .map(|_| rng.gen())
                .collect::<BTreeSet<i8>>();
            nums
                .into_iter()
                .map(|num| {
                    let record = (num, Some(num as u8 & 0x0f)).into();
                    Ok(record)
                })
                .transpose_into_fallible()
"#,
        order_fields: Some(["other_num"]),
        distinct_fields: Some(["other_num"]),
      )
    -> stream_2
  )

  ( < stream_1
    - [stream_2] join(
      primary_fields: ["num"],
      secondary_fields: ["other_num"],
    )
    - function_terminate(
        body: r#"
            while let Some(record) = input.next()? {
                if let Some(lsb4) = *record.lsb4() {
                    assert_eq!(*record.num() as u8 & 0x0f, lsb4);
                }
            }
            Ok(())
"#,
      )
  )
}
